<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0,  minimum-scale=1.0, maximum-scale=1.0,user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <script src="https://cdn.bootcss.com/jquery/3.2.0/jquery.min.js"></script>
    <link rel="stylesheet" href="./css/style.css">
    <title>吃啥</title>
</head>
<body>
<div class="main">
    <header>
        <h1>今天吃啥</h1>
        <h2 id="ok">不知道</h2>
        <p>点击加添加食物，点击食物即删除该食物</p>
        <p>点击开整开始选择，停则停，PC 端还可以用 ESC 键来控制</p>
    </header>
    <section class="foodarr-list">
        <ul class="foodUl"></ul>
        <div class="input">
            <input type="button" value="开整" id="start">
        </div>
    </section>
    <section class="foodarr-add">
        <div class="add">
            <input type="text" placeholder="再添加一个你想吃的东西" id="addFoodInput">
            <input type="button" value="加" id="addFood">
        </div>
    </section>
</div>
<script>
$(function(){
    (function(){
        var foodArr = new Array();
        
        (function getLocal() {
            var foodArrOld = JSON.parse(localStorage.getItem('foodArr'));
            
            if(foodArrOld){
                foodArr = foodArrOld;
                reloadDom(foodArr);
            } else {
                foodArr = ['冒', '金拱门', '粥', '麻辣烫', '饺子', '烤冷面', '锅贴 or 生煎', '面条'];
                // $('.foodUl').text('这就是列表');
                // getLocal();
                setFoodArr(foodArr);
            }
        })();
        
        // 添加食物按钮
        (function() {
            $('#addFood').click(function() {
                var addFoodInput = $('#addFoodInput').val();
                if(addFoodInput == ''){
                    alert('填点东西吧！');
                    return;
                } else if (addFoodInput.length > 8) {
                    alert('你能给我说说你吃的啥吗？八个字都不够写？？');
                    return;
                } else {
                    reloadFoodArr(addFoodInput);
                    $('#addFoodInput').val('');
                }
            });
        })();

        // 更新食物数组
        function reloadFoodArr(e) {
            foodArr.push(e);
            setFoodArr(foodArr);
        }

        // 写入localStorage
        function setFoodArr(arr) {
            localStorage.setItem('foodArr', JSON.stringify(arr));
            reloadDom(arr);
        }

        // 更新页面数据
        function reloadDom(arr) {
            var inHtml = '';
            for(let i = 0; i < arr.length; i++) {
                inHtml += `<li class="food" index="${i}">${arr[i]}</li>`;
            }
            $('.foodarr-list ul').empty().append(inHtml);
        }

        // 删除已有的数据
        (function delectFoodArr(e) {
            //TODO: 这里应该保留最后一个，不应该全部删除
            $(document).on('click', '.food', function() {
                var index = $(this).attr('index');
                foodArr.splice(index, 1);
                setFoodArr(foodArr);
                if(foodArr.length == 0){
                    $('.foodUl').text('这就是列表');
                }
            });
        })();  

        // 禁用添加
        function addFoodJy(bool) {
            bool ? ($('#addFoodInput').attr('disabled', 'true'),$('#start').val('停')) : ($('#addFoodInput').removeAttr('disabled'),$('#start').val('开整'));
        }

        // 取随机数
        function randomNum(num) {
            return Math.floor(Math.random() * num);
        }

        // 点击开整
        (function() {
            var startBool = false;
            var clear;
            $('#start').click(function() {
                goFood();
            });
            $(document).keyup(function(e) {
                var keycode = e.which;
                if(keycode == 27) {
                    goFood();
                }
            })

            function goFood() {
                if(startBool) {
                    addFoodJy(false);
                    startBool = false;
                    window.clearInterval(clear);
                } else {
                    var foodArrLength = foodArr.length;
                    if(foodArrLength == 0){
                        alert('不想点东西你整啥？');
                        return;
                    } else if (foodArrLength == 1) {
                        alert('就一个还能整别的？');
                        return;
                    } else {
                        addFoodJy(true);
                        startBool = true;
                        var foodNum = foodArr.length,
                            inNum = 0,
                            goNum = 0,
                            foodList = $('.foodUl').children('li'),
                            txt = $('#ok');

                        //TODO: 这里的算法需要更新
                        // 在当前食物数量少于3个的话就不需要进行随机操作了
                        function food() {
                            if(foodNum > 3){
                                var inNum = randomNum(foodNum);
                                foodList.eq(inNum).addClass('active').siblings('li').removeClass('active');
                                txt.text(foodArr[inNum] + '！');
                            } else {
                                foodList.eq(goNum).addClass('active').siblings('li').removeClass('active');
                                txt.text(foodArr[goNum] + '！');
                                goNum++;
                                goNum = (goNum == foodNum) ? 0 : goNum;
                            }
                        }
                        clear = window.setInterval(food, 60);
                    }
                }
            }
        })();
    })();
});
</script>
</body>
</html>